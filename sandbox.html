<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title>Delicious Trailmaker</title>

    <script src="js/jquery-1.8.0.min.js"></script>
    <script src="js/jquery-ui-1.8.23.custom.min.js"></script>
	<script src="js/jquery-ui-touch-punch.js"></script>

        <link rel="stylesheet" type="text/css" href="css/main2.css"/>
        <script src="js/main2.js"></script>
        
        		<script type="text/javascript">
		    // Create an empty global object where we can store settings for connecting to Delicious
		    var delicious = {};
		
		    // When users click on a link, open it in a new window
		    $('a').live('click', function() {
		        window.open($(this).attr('href'));
	            return false;
		    });

            $(document).ready(function() {

                // Load bookmarks for the specified user when the #load-bookmarks form is submitted
                $('#load-bookmarks').submit(function() {
                    var username = $('#username').val();
                    // This cross-domain request requires that you use '?callback=?' because it is done using JSONP
                    // If you don't add '?callback=?' to the end of this request, it will fail silently
                    $.getJSON('http://feeds.delicious.com/v2/json/' + username + '/' + trail + '/?callback=?',
                     function(json){
                        $(json).each(function(index) {
                            // this.u // url
                            // this.d // description
                            // this.n // extended notes
                            // this.t // array of tags
                            $('<li></li>').html('<a href="' + this.u + '">' + this.d + '</a>')
								.data('extended', this.n)
								.data('tags', this.t)
								.appendTo('#bookmarks ul');
                        });
					//	$('#bookmarks li').draggable({revert: true});
                    });
                    return false;
                });
				
				
                $('#save-trail').submit(function() {
                	// Let's ask the user for a name for the trail
                	// We are storing the name that the user enters as the text of the
                	// h2 in the #new-trail div
                	// The || syntax here lets us specify a default value
                    $('#new-trail h2').text(prompt('Enter a name for your trail:') || 'My New Trail');

                    // Store the username and password to send with each request
                    // This isn't the best security practice, but we do it here
                    // in the interest of brevity
                    delicious.username = $('#save-username').val();
                    delicious.password = $('#save-password').val();
                    delicious.stepNum = 0;

                    saveTrail();
                    return false;
            	});

                // Allow the user to rearrange the list of bookmarks in the new trail
				$('#new-trail ul').sortable();
            });
            
            function saveTrail () {
                // We need to keep track of which bookmark number we are saving, so we
                // can use the `step:2` syntax that we have established
                // When the user submitted the form we started with stepNum = 0,
                // so we can increment it each time we call saveTrail
                delicious.stepNum++;
                
                // Change spaces in the trail name to underscores to follow our trail syntax
                // By default, the .replace() method doesn't replace ALL the occurrances
            	// of a string, so we are using the global flag in our regular expression
            	// to replace everything. The global flag is set with the "g" after
            	// the regular expression (/ /g)
                var newTrailName = 'trail:' + $('#new-trail h2').text().toLowerCase().replace(/ /g, '_');
                
                // Get the first bookmark to save, which is the first element of the #new-trail list
                var bookmark = $('#new-trail li:first');
                
                // Assemble the data to send to Delicious
                var postData = {
                    url: bookmark.find('a').attr('href'),
                    description: bookmark.find('a').text(),
                    extended: bookmark.data('extended'),
                    tags: bookmark.data('tags').join(' ') + ' ' + newTrailName + ' ' + 'step:' + delicious.stepNum,
                    method: 'posts/add',
                    username: delicious.username,
                    password: delicious.password
                };
                
                // Send the data to Delicious through a proxy and handle the response
                // Use $.post if the script is located on the same server
                // Otherwise, use $.get to avoid cross-domain problems
                // $.post('delicious_proxy.php',
                $.getJSON("http://courses.ischool.berkeley.edu/i290-4/f09/resources/delicious_proxy.php?callback=?", 
                postData,
                 function(rsp){
                    if (rsp.result_code === "access denied") {
                        alert('The provided Delicious username and password are incorrect.');
                    } else if (rsp.result_code === "something went wrong") {
                        alert('There was an unspecified error communicating with Delicious.');
                    } else if (rsp.result_code === "done") {
                        // Bookmark was saved properly
                        $('#new-trail li:first').remove(); // Remove the line for the bookmark we just saved
                        if ($('#new-trail li').length > 0) {
                            // Save the next bookmark in the trail in 1000ms (1 second)
                            // We have to wait this period of time to comply with the
                            // terms of the Delicious API. If we don't we may have access denied.
                            setTimeout(saveTrail, 1000);
                        } else {
                            // We're done saving the trail
                            delicious.password = null;
                            alert ("Your trail has been saved!");
                        }
                    }
                });
            }
		</script>

        
    </head>

<body>
    <div id ="page">
      
        <h1>De.Flick.Us</h1>
     
	 <form id="fetch">
         <input autofocus="autofocus" type="text" placeholder="Enter a tag" id="term" />
         <button id="search">Load Photos</button>
     </form>
     
     <ul id="poster" class="connectedSortable">
     </ul>
	 
	<div id='new-trail'>
		<h2>New Trail</h2>
		<ul class='connectedSortable'></ul>
		
	</div>
	
	<form id='save-trail' action='' method='post'>
		<input id='save-username' type='text' name='save-username'>
		<input id='save-password' type='password' name='save-password'>
		<input type='submit' name='mail-trail' value='Make New Trail' id='mail-trail'>
		</form>

    </div>


<div id="page">

	<!--
		<h2>Trailmaker</h2>
		<form id='load-bookmarks' method='get'>
			<input type='text' name='username' id='username' value=''>
			<input type='submit' value='get bookmarks'>
		</form>
		
	<div id='bookmarks'>
		<h2>Bookmarks</h2>
		<ul></ul>
	</div>
	

	
	//-->
	
		
		
	</div> 


</body>
</html>